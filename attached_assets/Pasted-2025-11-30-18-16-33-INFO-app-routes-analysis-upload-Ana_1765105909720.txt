2025-11-30 18:16:33] [INFO] [app.routes.analysis_upload] Analysis completed suPS C:\Users\Mostafa\Downloads\BackEnd (Restrycterd+newENdPoints)\BackEnd>      
PS C:\Users\Mostafa\Downloads\BackEnd (Restrycterd+newENdPoints)\BackEnd> python run.py                                                                       
[2025-12-07 12:59:08] [INFO] [root] ============================================================
[2025-12-07 12:59:08] [INFO] [root] SHARIAA CONTRACT ANALYZER - STARTUP
[2025-12-07 12:59:08] [INFO] [root] ============================================================
[2025-12-07 12:59:08] [INFO] [root] Debug Mode: True
[2025-12-07 12:59:09] [INFO] [app.services.database] Attempting to connect to MongoDB...
[2025-12-07 12:59:11] [INFO] [app.services.database] Successfully connected to MongoDB: shariaa_analyzer_db
[2025-12-07 12:59:11] [INFO] [app.services.cloudinary_service] Cloudinary configured successfully
[2025-12-07 12:59:14] [INFO] [app.services.ai_service] Google GenAI service initialized (client will be created per request)
 * Serving Flask app 'app'
 * Debug mode: on
[2025-12-07 12:59:32] [INFO] [app.routes.analysis_terms] Retrieving session details for ID: 3d79a38a-82bf-47b4-9132-41d11f590b3b
[2025-12-07 12:59:32] [INFO] [app.routes.analysis_terms] Retrieving terms for session: 3d79a38a-82bf-47b4-9132-41d11f590b3b
[2025-12-07 12:59:49] [INFO] [app.routes.analysis_upload] Starting file analysis for session: af1e3fa3-e66e-4bee-880a-3a6d75df3cb0
[2025-12-07 12:59:49] [INFO] [app.routes.analysis_upload] Processing file: nmwdhj_qd_lmqwl.pdf for session: af1e3fa3-e66e-4bee-880a-3a6d75df3cb0
[2025-12-07 12:59:49] [DEBUG] [app.utils.text_processing] Generated safe public_id: original_nmwdhj_qd_lmqwl_0db279 from base_name: nmwdhj_qd_lmqwl
[2025-12-07 12:59:51] [INFO] [app.routes.analysis_upload] Original file uploaded to Cloudinary: https://res.cloudinary.com/dr6jicgld/image/upload/v1765105192/shariaa_analyzer_uploads/af1e3fa3-e66e-4bee-880a-3a6d75df3cb0/original_contracts/original_nmwdhj_qd_lmqwl_0db279.pdf
Attempting to download from URL: https://res.cloudinary.com/dr6jicgld/image/upload/v1765105192/shariaa_analyzer_uploads/af1e3fa3-e66e-4bee-880a-3a6d75df3cb0/original_contracts/original_nmwdhj_qd_lmqwl_0db279.pdf
File successfully downloaded to temporary path: C:\Users\Mostafa\AppData\Local\Temp\shariaa_analyzer_temp\processing_files\tmpusuv1c7a.pdf
[2025-12-07 12:59:52] [INFO] [app.routes.analysis_upload] Processing file with extension: .pdf
[2025-12-07 12:59:52] [INFO] [app.routes.analysis_upload] Processing .PDF file 
[2025-12-07 12:59:52] [INFO] [app.services.ai_service] Extracting text from file: C:\Users\Mostafa\AppData\Local\Temp\shariaa_analyzer_temp\processing_files\tmpusuv1c7a.pdf
[2025-12-07 12:59:52] [INFO] [app.services.ai_service] Creating GenAI client with API Key: AIzaSyAK...5NAk
[2025-12-07 12:59:52] [WARNING] [google_genai._api_client] Both GOOGLE_API_KEY and GEMINI_API_KEY are set. Using GOOGLE_API_KEY.
[2025-12-07 12:59:54] [INFO] [google_genai.models] AFC is enabled with max remote calls: 10.
[2025-12-07 13:00:12] [INFO] [app.services.ai_service] Successfully extracted text from C:\Users\Mostafa\AppData\Local\Temp\shariaa_analyzer_temp\processing_files\tmpusuv1c7a.pdf. Text length: 9493
[2025-12-07 13:00:12] [INFO] [app.routes.analysis_upload] Extracted 9440 characters from .PDF
[2025-12-07 13:00:13] [INFO] [app.routes.analysis_upload] Detected contract language: ar
[2025-12-07 13:00:13] [INFO] [app.routes.analysis_upload] Retrieving AAOIFI standards context...
[2025-12-07 13:00:13] [INFO] [app.services.file_search] google-genai version: 1.52.0
[2025-12-07 13:00:13] [INFO] [app.services.file_search] google-genai version: 1.52.0
[2025-12-07 13:00:13] [WARNING] [google_genai._api_client] Both GOOGLE_API_KEY and GEMINI_API_KEY are set. Using GOOGLE_API_KEY.
[2025-12-07 13:00:14] [INFO] [app.services.file_search] FileSearchService initialized using API Key: ****tmCM
[2025-12-07 13:00:14] [INFO] [app.services.file_search] FileSearchService initialized using API Key: ****tmCM
[2025-12-07 13:00:14] [INFO] [app.services.file_search] Model: gemini-2.5-flash
[2025-12-07 13:00:14] [INFO] [app.services.file_search] Model: gemini-2.5-flash
[2025-12-07 13:00:14] [INFO] [app.services.file_search] File Search Enabled: True
[2025-12-07 13:00:14] [INFO] [app.services.file_search] File Search Enabled: True
[2025-12-07 13:00:14] [INFO] [app.services.file_search] Store ID: fileSearchStores/aaoifi-reference-store-3rerps28a9vx
[2025-12-07 13:00:14] [INFO] [app.services.file_search] Store ID: fileSearchStores/aaoifi-reference-store-3rerps28a9vx
[2025-12-07 13:00:14] [INFO] [app.services.file_search] ============================================================
[2025-12-07 13:00:14] [INFO] [app.services.file_search] ============================================================
[2025-12-07 13:00:14] [INFO] [app.services.file_search] HYBRID FILE SEARCH PROCESS (Two-Step + Sensitive Clauses)
[2025-12-07 13:00:14] [INFO] [app.services.file_search] HYBRID FILE SEARCH PROCESS (Two-Step + Sensitive Clauses)
[2025-12-07 13:00:14] [INFO] [app.services.file_search] ============================================================
[2025-12-07 13:00:14] [INFO] [app.services.file_search] ============================================================
[2025-12-07 13:00:14] [INFO] [app.services.file_search] Using API Key: ****tmCM
[2025-12-07 13:00:14] [INFO] [app.services.file_search] Using API Key: ****tmCM
[2025-12-07 13:00:14] [INFO] [app.services.file_search] STEP 1/2: Extracting key terms from contract...
[2025-12-07 13:00:14] [INFO] [app.services.file_search] STEP 1/2: Extracting key terms from contract...
[2025-12-07 13:00:14] [INFO] [app.services.file_search] Contract length: 9493 characters
[2025-12-07 13:00:14] [INFO] [app.services.file_search] Contract length: 9493 characters
[2025-12-07 13:00:14] [INFO] [app.services.file_search] Using API Key: ****tmCM
[2025-12-07 13:00:14] [INFO] [app.services.file_search] Using API Key: ****tmCM
[2025-12-07 13:00:14] [ERROR] [app.services.file_search] Term extraction failed: 'DefaultConfig' object has no attribute 'EXTRACT_KEY_TERMS_PROMPT'
[2025-12-07 13:00:14] [ERROR] [app.services.file_search] Term extraction failed: 'DefaultConfig' object has no attribute 'EXTRACT_KEY_TERMS_PROMPT'
Traceback (most recent call last):
  File "C:\Users\Mostafa\Downloads\BackEnd (Restrycterd+newENdPoints)\BackEnd\app\services\file_search.py", line 227, in extract_key_terms
    extraction_prompt = self.extract_prompt_template.format(contract_text=contract_text)
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Mostafa\Downloads\BackEnd (Restrycterd+newENdPoints)\BackEnd\app\services\file_search.py", line 84, in extract_prompt_template
    return config.EXTRACT_KEY_TERMS_PROMPT
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DefaultConfig' object has no attribute 'EXTRACT_KEY_TERMS_PROMPT'
[2025-12-07 13:00:14] [WARNING] [app.services.file_search] No terms extracted, falling back to full contract search
[2025-12-07 13:00:14] [WARNING] [app.services.file_search] No terms extracted, falling back to full contract search
[2025-12-07 13:00:14] [INFO] [app.services.file_search] PHASE 1/2: General Search for all extracted clauses...
[2025-12-07 13:00:14] [INFO] [app.services.file_search] PHASE 1/2: General Search for all extracted clauses...
[2025-12-07 13:00:14] [INFO] [app.services.file_search] Using top_k=10 for comprehensive coverage
[2025-12-07 13:00:14] [INFO] [app.services.file_search] Using top_k=10 for comprehensive coverage
[2025-12-07 13:00:14] [ERROR] [app.services.file_search] Search failed: 'DefaultConfig' object has no attribute 'FILE_SEARCH_PROMPT'
[2025-12-07 13:00:14] [ERROR] [app.services.file_search] Search failed: 'DefaultConfig' object has no attribute 'FILE_SEARCH_PROMPT'
Traceback (most recent call last):
  File "C:\Users\Mostafa\Downloads\BackEnd (Restrycterd+newENdPoints)\BackEnd\app\services\file_search.py", line 341, in search_chunks
    full_prompt = self.search_prompt_template.format(extracted_clauses=extracted_clauses_text)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Mostafa\Downloads\BackEnd (Restrycterd+newENdPoints)\BackEnd\app\services\file_search.py", line 90, in search_prompt_template
    return config.FILE_SEARCH_PROMPT
           ^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DefaultConfig' object has no attribute 'FILE_SEARCH_PROMPT'   
[2025-12-07 13:00:14] [WARNING] [app.routes.analysis_upload] File search failed, proceeding without AAOIFI context: 'DefaultConfig' object has no attribute 'FILE_SEARCH_PROMPT'
[2025-12-07 13:00:14] [INFO] [app.routes.analysis_upload] Sending contract to LLM for analysis with AAOIFI context
[2025-12-07 13:00:14] [INFO] [app.services.ai_service] Sending text to LLM for session: af1e3fa3-e66e-4bee-880a-3a6d75df3cb0_analysis_final, payload length: 9493
[2025-12-07 13:00:14] [INFO] [app.services.ai_service] Creating new chat session for key: af1e3fa3-e66e-4bee-880a-3a6d75df3cb0_analysis_final
[2025-12-07 13:00:14] [INFO] [app.services.ai_service] Creating GenAI client with API Key: AIzaSyAK...5NAk
[2025-12-07 13:00:14] [WARNING] [google_genai._api_client] Both GOOGLE_API_KEY and GEMINI_API_KEY are set. Using GOOGLE_API_KEY.
[2025-12-07 13:00:15] [INFO] [app.services.ai_service] Sending request to AI API (attempt 1/3)
[2025-12-07 13:00:15] [INFO] [google_genai.models] AFC is enabled with max remote calls: 10.
[2025-12-07 13:00:59] [INFO] [app.services.ai_service] Received successful response for session af1e3fa3-e66e-4bee-880a-3a6d75df3cb0_analysis_final. Response text length: 15159
[2025-12-07 13:00:59] [INFO] [app.routes.analysis_upload] Parsing LLM analysis results
[2025-12-07 13:00:59] [INFO] [app.routes.analysis_upload] Analysis completed with 20 terms identified
[2025-12-07 13:00:59] [DEBUG] [app.utils.text_processing] Generated safe public_id: analysis_results_nmwdhj_qd_lmqwl_ec83ff from base_name: nmwdhj_qd_lmqwl   
[2025-12-07 13:00:59] [DEBUG] [app.services.cloudinary_service] DEBUG: Attempting to upload to Cloudinary. File: C:\Users\Mostafa\AppData\Local\Temp\shariaa_analyzer_temp\processing_files\tmpe1ac1r4y.json, Options: {'folder': 'shariaa_analyzer_uploads/af1e3fa3-e66e-4bee-880a-3a6d75df3cb0/analysis_results_json', 'public_id': 'analysis_results_nmwdhj_qd_lmqwl_ec83ff', 'resource_type': 'raw', 'overwrite': True}
[2025-12-07 13:01:00] [DEBUG] [app.services.cloudinary_service] DEBUG: Raw Cloudinary upload_result for C:\Users\Mostafa\AppData\Local\Temp\shariaa_analyzer_temp\processing_files\tmpe1ac1r4y.json: {'asset_id': '271023afd22e65d9d5ddce9b6ec42333', 'public_id': 'shariaa_analyzer_uploads/af1e3fa3-e66e-4bee-880a-3a6d75df3cb0/analysis_results_json/analysis_results_nmwdhj_qd_lmqwl_ec83ff.json', 'version': 1765105260, 'version_id': '246b36f3aa5efb52dba9ed2e32248408', 'signature': '2333dad97abec901455907ccbbfa19db7a4303c6', 'resource_type': 'raw', 'created_at': '2025-12-07T11:01:00Z', 'tags': [], 'bytes': 23027, 'type': 'upload', 'etag': 'cf29814b8897976bea4b86501247a5c7', 'placeholder': False, 'url': 'http://res.cloudinary.com/dr6jicgld/raw/upload/v1765105260/shariaa_analyzer_uploads/af1e3fa3-e66e-4bee-880a-3a6d75df3cb0/analysis_results_json/analysis_results_nmwdhj_qd_lmqwl_ec83ff.json', 'secure_url': 'https://res.cloudinary.com/dr6jicgld/raw/upload/v1765105260/shariaa_analyzer_uploads/af1e3fa3-e66e-4bee-880a-3a6d75df3cb0/analysis_results_json/analysis_results_nmwdhj_qd_lmqwl_ec83ff.json', 'asset_folder': 'shariaa_analyzer_uploads/af1e3fa3-e66e-4bee-880a-3a6d75df3cb0/analysis_results_json', 'display_name': 'analysis_results_nmwdhj_qd_lmqwl_ec83ff.json', 'original_filename': 'tmpe1ac1r4y', 'api_key': '961637465179968'}
[2025-12-07 13:01:00] [INFO] [app.services.cloudinary_service] Cloudinary upload successful. URL: https://res.cloudinary.com/dr6jicgld/raw/upload/v1765105260/shariaa_analyzer_uploads/af1e3fa3-e66e-4bee-880a-3a6d75df3cb0/analysis_results_json/analysis_results_nmwdhj_qd_lmqwl_ec83ff.json
[2025-12-07 13:01:00] [INFO] [app.routes.analysis_upload] Analysis results uploaded to Cloudinary
[2025-12-07 13:01:00] [INFO] [app.routes.analysis_upload] Contract document saved to database for session: af1e3fa3-e66e-4bee-880a-3a6d75df3cb0
[2025-12-07 13:01:00] [INFO] [app.routes.analysis_upload] Inserted 20 terms to database
[2025-12-07 13:01:00] [INFO] [app.routes.analysis_upload] Analysis completed successfully for session: af1e3fa3-e66e-4bee-880a-3a6d75df3cb0
[2025-12-07 13:01:00] [DEBUG] [app.routes.analysis_upload] Cleaned up temporary processing file
[2025-12-07 13:01:00] [DEBUG] [app.routes.analysis_upload] Cleaned up temporary analysis results file
[2025-12-07 13:01:00] [INFO] [app.routes.analysis_terms] Retrieving session details for ID: af1e3fa3-e66e-4bee-880a-3a6d75df3cb0
[2025-12-07 13:01:00] [INFO] [app.routes.analysis_terms] Retrieving terms for session: af1e3fa3-e66e-4bee-880a-3a6d75df3cb0
