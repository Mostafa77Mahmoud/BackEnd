PS C:\Users\Mostafa\Downloads\BackEnd (Restrycterd+newENdPoints)\BackEnd> git mPS C:\Users\Mostafa\Downloads\BackEnd (Restrycterd+newENdPoints)\BackEnd> python run.py       
[2025-11-30 18:15:16] [INFO] [root] ============================================================
[2025-11-30 18:15:16] [INFO] [root] SHARIAA CONTRACT ANALYZER - STARTUP
[2025-11-30 18:15:16] [INFO] [root] ============================================================
[2025-11-30 18:15:16] [INFO] [root] Debug Mode: True
[2025-11-30 18:15:17] [INFO] [app.services.database] Attempting to connect to MongoDB...
[2025-11-30 18:15:18] [INFO] [app.services.database] Successfully connected to MongoDB: shariaa_analyzer_db
[2025-11-30 18:15:19] [INFO] [app.services.cloudinary_service] Cloudinary configured successfully
[2025-11-30 18:15:22] [INFO] [app.services.ai_service] Google GenAI service initialized (client will be created per request)
 * Serving Flask app 'app'
 * Debug mode: on
[2025-11-30 18:15:31] [INFO] [app.routes.analysis_upload] Starting file analysis for session: 23c26436-bf4a-4fa9-b670-d4cd5721b28a
[2025-11-30 18:15:33] [INFO] [app.routes.analysis_upload] Processing file: Document_51.pdf for session: 23c26436-bf4a-4fa9-b670-d4cd5721b28a
[2025-11-30 18:15:33] [DEBUG] [app.utils.text_processing] Generated safe public_id: original_Document_51_f27159 from base_name: Document_51
[2025-11-30 18:15:36] [INFO] [app.routes.analysis_upload] Original file uploaded to Cloudinary: https://res.cloudinary.com/dr6jicgld/image/upload/v1764519336/shariaa_analyzer_uploads/23c26436-bf4a-4fa9-b670-d4cd5721b28a/original_contracts/original_Document_51_f27159.pdf
Attempting to download from URL: https://res.cloudinary.com/dr6jicgld/image/upload/v1764519336/shariaa_analyzer_uploads/23c26436-bf4a-4fa9-b670-d4cd5721b28a/original_contracts/original_Document_51_f27159.pdf
File successfully downloaded to temporary path: C:\Users\Mostafa\AppData\Local\Temp\shariaa_analyzer_temp\processing_files\tmpqeidf8wy.pdf
[2025-11-30 18:15:37] [INFO] [app.routes.analysis_upload] Processing file with extension: .pdf
[2025-11-30 18:15:37] [INFO] [app.routes.analysis_upload] Processing .PDF file 
[2025-11-30 18:15:37] [INFO] [app.services.ai_service] Extracting text from file: C:\Users\Mostafa\AppData\Local\Temp\shariaa_analyzer_temp\processing_files\tmpqeidf8wy.pdf
[2025-11-30 18:15:37] [INFO] [app.services.ai_service] Creating GenAI client with API Key: AIzaSyAK...5NAk
[2025-11-30 18:15:37] [WARNING] [google_genai._api_client] Both GOOGLE_API_KEY and GEMINI_API_KEY are set. Using GOOGLE_API_KEY.
[2025-11-30 18:15:38] [INFO] [google_genai.models] AFC is enabled with max remote calls: 10.
[2025-11-30 18:15:55] [INFO] [app.services.ai_service] Successfully extracted text from C:\Users\Mostafa\AppData\Local\Temp\shariaa_analyzer_temp\processing_files\tmpqeidf8wy.pdf. Text length: 6600
[2025-11-30 18:15:55] [INFO] [app.routes.analysis_upload] Extracted 6559 characters from .PDF
[2025-11-30 18:15:56] [INFO] [app.routes.analysis_upload] Detected contract language: ar
[2025-11-30 18:15:56] [INFO] [app.routes.analysis_upload] Retrieving AAOIFI standards context...
[2025-11-30 18:15:56] [INFO] [app.services.file_search] google-genai version: 1.52.0
[2025-11-30 18:15:56] [INFO] [app.services.file_search] google-genai version: 1.52.0
[2025-11-30 18:15:56] [WARNING] [google_genai._api_client] Both GOOGLE_API_KEY and GEMINI_API_KEY are set. Using GOOGLE_API_KEY.
[2025-11-30 18:15:57] [INFO] [app.services.file_search] FileSearchService initialized using API Key: ****tmCM
[2025-11-30 18:15:57] [INFO] [app.services.file_search] FileSearchService initialized using API Key: ****tmCM
[2025-11-30 18:15:57] [INFO] [app.services.file_search] Model: gemini-2.5-flash
[2025-11-30 18:15:57] [INFO] [app.services.file_search] Model: gemini-2.5-flash
[2025-11-30 18:15:57] [INFO] [app.services.file_search] File Search Enabled: True
[2025-11-30 18:15:57] [INFO] [app.services.file_search] File Search Enabled: True
[2025-11-30 18:15:57] [INFO] [app.services.file_search] Store ID: fileSearchStores/aaoifi-reference-store-vwvmgtb64hqq
[2025-11-30 18:15:57] [INFO] [app.services.file_search] Store ID: fileSearchStores/aaoifi-reference-store-vwvmgtb64hqq
[2025-11-30 18:15:57] [INFO] [app.services.file_search] ============================================================
[2025-11-30 18:15:57] [INFO] [app.services.file_search] ============================================================
[2025-11-30 18:15:57] [INFO] [app.services.file_search] HYBRID FILE SEARCH PROCESS (Two-Step + Sensitive Clauses)
[2025-11-30 18:15:57] [INFO] [app.services.file_search] HYBRID FILE SEARCH PROCESS (Two-Step + Sensitive Clauses)
[2025-11-30 18:15:57] [INFO] [app.services.file_search] ============================================================
[2025-11-30 18:15:57] [INFO] [app.services.file_search] ============================================================
[2025-11-30 18:15:57] [INFO] [app.services.file_search] Using API Key: ****tmCM
[2025-11-30 18:15:57] [INFO] [app.services.file_search] Using API Key: ****tmCM
[2025-11-30 18:15:57] [INFO] [app.services.file_search] STEP 1/2: Extracting key terms from contract...
[2025-11-30 18:15:57] [INFO] [app.services.file_search] STEP 1/2: Extracting key terms from contract...
[2025-11-30 18:15:57] [INFO] [app.services.file_search] Contract length: 6600 characters
[2025-11-30 18:15:57] [INFO] [app.services.file_search] Contract length: 6600 characters
[2025-11-30 18:15:57] [INFO] [app.services.file_search] Using API Key: ****tmCM
[2025-11-30 18:15:57] [INFO] [app.services.file_search] Using API Key: ****tmCM
[2025-11-30 18:15:57] [ERROR] [app.services.file_search] Term extraction failed: 'DefaultConfig' object has no attribute 'EXTRACT_KEY_TERMS_PROMPT'
[2025-11-30 18:15:57] [ERROR] [app.services.file_search] Term extraction failed: 'DefaultConfig' object has no attribute 'EXTRACT_KEY_TERMS_PROMPT'
Traceback (most recent call last):
  File "C:\Users\Mostafa\Downloads\BackEnd (Restrycterd+newENdPoints)\BackEnd\app\services\file_search.py", line 227, in extract_key_terms
    extraction_prompt = self.extract_prompt_template.format(contract_text=contract_text)
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Mostafa\Downloads\BackEnd (Restrycterd+newENdPoints)\BackEnd\app\services\file_search.py", line 84, in extract_prompt_template
    return config.EXTRACT_KEY_TERMS_PROMPT
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DefaultConfig' object has no attribute 'EXTRACT_KEY_TERMS_PROMPT'
[2025-11-30 18:15:57] [WARNING] [app.services.file_search] No terms extracted, falling back to full contract search
[2025-11-30 18:15:57] [WARNING] [app.services.file_search] No terms extracted, falling back to full contract search
[2025-11-30 18:15:57] [INFO] [app.services.file_search] PHASE 1/2: General Search for all extracted clauses...
[2025-11-30 18:15:57] [INFO] [app.services.file_search] PHASE 1/2: General Search for all extracted clauses...
[2025-11-30 18:15:57] [INFO] [app.services.file_search] Using top_k=10 for comprehensive coverage
[2025-11-30 18:15:57] [INFO] [app.services.file_search] Using top_k=10 for comprehensive coverage
[2025-11-30 18:15:57] [ERROR] [app.services.file_search] Search failed: 'DefaultConfig' object has no attribute 'FILE_SEARCH_PROMPT'
[2025-11-30 18:15:57] [ERROR] [app.services.file_search] Search failed: 'DefaultConfig' object has no attribute 'FILE_SEARCH_PROMPT'
Traceback (most recent call last):
  File "C:\Users\Mostafa\Downloads\BackEnd (Restrycterd+newENdPoints)\BackEnd\app\services\file_search.py", line 341, in search_chunks
    full_prompt = self.search_prompt_template.format(extracted_clauses=extracted_clauses_text)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Mostafa\Downloads\BackEnd (Restrycterd+newENdPoints)\BackEnd\app\services\file_search.py", line 90, in search_prompt_template
    return config.FILE_SEARCH_PROMPT
           ^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'DefaultConfig' object has no attribute 'FILE_SEARCH_PROMPT'   
[2025-11-30 18:15:57] [WARNING] [app.routes.analysis_upload] File search failed, proceeding without AAOIFI context: 'DefaultConfig' object has no attribute 'FILE_SEARCH_PROMPT'
[2025-11-30 18:15:57] [INFO] [app.routes.analysis_upload] Sending contract to LLM for analysis with AAOIFI context
[2025-11-30 18:15:57] [INFO] [app.services.ai_service] Sending text to LLM for session: 23c26436-bf4a-4fa9-b670-d4cd5721b28a_analysis_final, payload length: 6600
[2025-11-30 18:15:57] [INFO] [app.services.ai_service] Creating new chat session for key: 23c26436-bf4a-4fa9-b670-d4cd5721b28a_analysis_final
[2025-11-30 18:15:57] [INFO] [app.services.ai_service] Creating GenAI client with API Key: AIzaSyAK...5NAk
[2025-11-30 18:15:57] [WARNING] [google_genai._api_client] Both GOOGLE_API_KEY and GEMINI_API_KEY are set. Using GOOGLE_API_KEY.
[2025-11-30 18:15:58] [INFO] [app.services.ai_service] Sending request to AI API (attempt 1/3)
[2025-11-30 18:15:58] [INFO] [google_genai.models] AFC is enabled with max remote calls: 10.
[2025-11-30 18:16:32] [INFO] [app.services.ai_service] Received successful response for session 23c26436-bf4a-4fa9-b670-d4cd5721b28a_analysis_final. Response text length: 11574
[2025-11-30 18:16:32] [INFO] [app.routes.analysis_upload] Parsing LLM analysis results
[2025-11-30 18:16:32] [INFO] [app.routes.analysis_upload] Analysis completed with 13 terms identified
[2025-11-30 18:16:32] [DEBUG] [app.utils.text_processing] Generated safe public_id: analysis_results_Document_51_802c85 from base_name: Document_51
[2025-11-30 18:16:32] [DEBUG] [app.services.cloudinary_service] DEBUG: Attempting to upload to Cloudinary. File: C:\Users\Mostafa\AppData\Local\Temp\shariaa_analyzer_temp\processing_files\tmpqt3_8k5_.json, Options: {'folder': 'shariaa_analyzer_uploads/23c26436-bf4a-4fa9-b670-d4cd5721b28a/analysis_results_json', 'public_id': 'analysis_results_Document_51_802c85', 'resource_type': 'raw', 'overwrite': True}
[2025-11-30 18:16:33] [DEBUG] [app.services.cloudinary_service] DEBUG: Raw Cloudinary upload_result for C:\Users\Mostafa\AppData\Local\Temp\shariaa_analyzer_temp\processing_files\tmpqt3_8k5_.json: {'asset_id': '4ba6733e01538db45cf90d882a9446dd', 'public_id': 'shariaa_analyzer_uploads/23c26436-bf4a-4fa9-b670-d4cd5721b28a/analysis_results_json/analysis_results_Document_51_802c85.json', 'version': 1764519393, 'version_id': 'ec1765c38c22711581e6fdf3140aa636', 'signature': 'd7c1b4c93a9f9076f606022af7b29b8929f29df5', 'resource_type': 'raw', 'created_at': '2025-11-30T16:16:33Z', 'tags': [], 'bytes': 17937, 'type': 'upload', 'etag': '5f00c332efc6d61d1c6560cc6d712896', 'placeholder': False, 'url': 'http://res.cloudinary.com/dr6jicgld/raw/upload/v1764519393/shariaa_analyzer_uploads/23c26436-bf4a-4fa9-b670-d4cd5721b28a/analysis_results_json/analysis_results_Document_51_802c85.json', 'secure_url': 'https://res.cloudinary.com/dr6jicgld/raw/upload/v1764519393/shariaa_analyzer_uploads/23c26436-bf4a-4fa9-b670-d4cd5721b28a/analysis_results_json/analysis_results_Document_51_802c85.json', 'asset_folder': 'shariaa_analyzer_uploads/23c26436-bf4a-4fa9-b670-d4cd5721b28a/analysis_results_json', 'display_name': 'analysis_results_Document_51_802c85.json', 'original_filename': 'tmpqt3_8k5_', 'api_key': '961637465179968'}
[2025-11-30 18:16:33] [INFO] [app.services.cloudinary_service] Cloudinary upload successful. URL: https://res.cloudinary.com/dr6jicgld/raw/upload/v1764519393/shariaa_analyzer_uploads/23c26436-bf4a-4fa9-b670-d4cd5721b28a/analysis_results_json/analysis_results_Document_51_802c85.json
[2025-11-30 18:16:33] [INFO] [app.routes.analysis_upload] Analysis results uploaded to Cloudinary
[2025-11-30 18:16:33] [INFO] [app.routes.analysis_upload] Contract document saved to database for session: 23c26436-bf4a-4fa9-b670-d4cd5721b28a
[2025-11-30 18:16:33] [INFO] [app.routes.analysis_upload] Inserted 13 terms to database
[2025-11-30 18:16:33] [INFO] [app.routes.analysis_upload] Analysis completed successfully for session: 23c26436-bf4a-4fa9-b670-d4cd5721b28a
[2025-11-30 18:16:33] [DEBUG] [app.routes.analysis_upload] Cleaned up temporary processing file
[2025-11-30 18:16:33] [DEBUG] [app.routes.analysis_upload] Cleaned up temporary analysis results file
[2025-11-30 18:16:34] [INFO] [app.routes.analysis_terms] Retrieving terms for session: 23c26436-bf4a-4fa9-b670-d4cd5721b28a
[2025-11-30 18:16:34] [INFO] [app.routes.analysis_terms] Retrieving session details for ID: 23c26436-bf4a-4fa9-b670-d4cd5721b28a
