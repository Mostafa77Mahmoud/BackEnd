اي الي حصل بظبط
دي السجلات 
PS C:\Users\Mostafa\Downloads\BackEnd (Restrycterd+newENdPoints)\BackEnd> python run.py
[2025-12-07 14:00:32] [INFO] [root] ============================================================
[2025-12-07 14:00:32] [INFO] [root] SHARIAA CONTRACT ANALYZER - STARTUP
[2025-12-07 14:00:32] [INFO] [root] ============================================================
[2025-12-07 14:00:32] [INFO] [root] Debug Mode: True
[2025-12-07 14:00:32] [INFO] [app.services.database] Attempting to connect to MongoDB...
[2025-12-07 14:00:33] [INFO] [app.services.database] Successfully connected to MongoDB: shariaa_analyzer_db
[2025-12-07 14:00:34] [INFO] [app.services.cloudinary_service] Cloudinary configured successfully
[2025-12-07 14:00:35] [INFO] [app.services.ai_service] Google GenAI service initialized (client will be created per request)
 * Serving Flask app 'app'
 * Debug mode: on
[2025-12-07 14:00:38] [INFO] [app.routes.analysis_upload] Starting file analysis for session: 75afe9b1-6e2c-423f-bdc2-9733df8e68a6
[2025-12-07 14:00:39] [INFO] [app.routes.analysis_upload] Processing file: nmwdhj_qd_lmqwl.pdf for session: 75afe9b1-6e2c-423f-bdc2-9733df8e68a6
[2025-12-07 14:00:39] [DEBUG] [app.utils.text_processing] Generated safe public_id: original_nmwdhj_qd_lmqwl_a34b37 from base_name: nmwdhj_qd_lmqwl
[2025-12-07 14:00:41] [INFO] [app.routes.analysis_upload] Original file uploaded to Cloudinary: https://res.cloudinary.com/dr6jicgld/image/upload/v1765108841/shariaa_analyzer_uploads/75afe9b1-6e2c-423f-bdc2-9733df8e68a6/original_contracts/original_nmwdhj_qd_lmqwl_a34b37.pdf
Attempting to download from URL: https://res.cloudinary.com/dr6jicgld/image/upload/v1765108841/shariaa_analyzer_uploads/75afe9b1-6e2c-423f-bdc2-9733df8e68a6/original_contracts/original_nmwdhj_qd_lmqwl_a34b37.pdf
File successfully downloaded to temporary path: C:\Users\Mostafa\AppData\Local\Temp\shariaa_analyzer_temp\processing_files\tmph893yop0.pdf
[2025-12-07 14:00:42] [INFO] [app.routes.analysis_upload] Processing file with extension: .pdf
[2025-12-07 14:00:42] [INFO] [app.routes.analysis_upload] Processing .PDF file 
[2025-12-07 14:00:42] [INFO] [app.services.ai_service] Extracting text from file: C:\Users\Mostafa\AppData\Local\Temp\shariaa_analyzer_temp\processing_files\tmph893yop0.pdf
[2025-12-07 14:00:42] [INFO] [app.services.ai_service] Creating GenAI client with API Key: AIzaSyAK...5NAk
[2025-12-07 14:00:42] [WARNING] [google_genai._api_client] Both GOOGLE_API_KEY and GEMINI_API_KEY are set. Using GOOGLE_API_KEY.
[2025-12-07 14:00:43] [INFO] [google_genai.models] AFC is enabled with max remote calls: 10.
[2025-12-07 14:01:01] [INFO] [app.services.ai_service] Successfully extracted text from C:\Users\Mostafa\AppData\Local\Temp\shariaa_analyzer_temp\processing_files\tmph893yop0.pdf. Text length: 9459
[2025-12-07 14:01:01] [INFO] [app.routes.analysis_upload] Extracted 9457 characters from .PDF
[2025-12-07 14:01:01] [INFO] [app.routes.analysis_upload] Detected contract language: ar
[2025-12-07 14:01:01] [INFO] [app.routes.analysis_upload] Retrieving AAOIFI standards context...
[2025-12-07 14:01:01] [INFO] [app.services.file_search] google-genai version: 1.52.0
[2025-12-07 14:01:01] [INFO] [app.services.file_search] google-genai version: 1.52.0
[2025-12-07 14:01:01] [WARNING] [google_genai._api_client] Both GOOGLE_API_KEY and GEMINI_API_KEY are set. Using GOOGLE_API_KEY.
[2025-12-07 14:01:02] [INFO] [app.services.file_search] FileSearchService initialized using API Key: ****O7vg
[2025-12-07 14:01:02] [INFO] [app.services.file_search] FileSearchService initialized using API Key: ****O7vg
[2025-12-07 14:01:02] [INFO] [app.services.file_search] Model: gemini-2.5-flash
[2025-12-07 14:01:02] [INFO] [app.services.file_search] Model: gemini-2.5-flash
[2025-12-07 14:01:02] [INFO] [app.services.file_search] File Search Enabled: True
[2025-12-07 14:01:02] [INFO] [app.services.file_search] File Search Enabled: True
[2025-12-07 14:01:02] [INFO] [app.services.file_search] Store ID: fileSearchStores/aaoifi-reference-store-3rerps28a9vx
[2025-12-07 14:01:02] [INFO] [app.services.file_search] Store ID: fileSearchStores/aaoifi-reference-store-3rerps28a9vx
[2025-12-07 14:01:02] [INFO] [app.services.file_search] ============================================================
[2025-12-07 14:01:02] [INFO] [app.services.file_search] ============================================================
[2025-12-07 14:01:02] [INFO] [app.services.file_search] HYBRID FILE SEARCH PROCESS (Two-Step + Sensitive Clauses)
[2025-12-07 14:01:02] [INFO] [app.services.file_search] HYBRID FILE SEARCH PROCESS (Two-Step + Sensitive Clauses)
[2025-12-07 14:01:02] [INFO] [app.services.file_search] ============================================================
[2025-12-07 14:01:02] [INFO] [app.services.file_search] ============================================================
[2025-12-07 14:01:02] [INFO] [app.services.file_search] Using API Key: ****O7vg
[2025-12-07 14:01:02] [INFO] [app.services.file_search] Using API Key: ****O7vg
[2025-12-07 14:01:02] [INFO] [app.services.file_search] STEP 1/2: Extracting key terms from contract...
[2025-12-07 14:01:02] [INFO] [app.services.file_search] STEP 1/2: Extracting key terms from contract...
[2025-12-07 14:01:02] [INFO] [app.services.file_search] Contract length: 9459 characters
[2025-12-07 14:01:02] [INFO] [app.services.file_search] Contract length: 9459 characters
[2025-12-07 14:01:02] [INFO] [app.services.file_search] Using API Key: ****O7vg
[2025-12-07 14:01:02] [INFO] [app.services.file_search] Using API Key: ****O7vg
[2025-12-07 14:01:02] [ERROR] [app.services.file_search] Prompt formatting error: '\n    "term_id"'
[2025-12-07 14:01:02] [ERROR] [app.services.file_search] Prompt formatting error: '\n    "term_id"'
[2025-12-07 14:01:02] [INFO] [app.services.file_search] Calling Gemini for term extraction...
[2025-12-07 14:01:02] [INFO] [app.services.file_search] Calling Gemini for term extraction...
[2025-12-07 14:01:02] [INFO] [google_genai.models] AFC is enabled with max remote calls: 10.
[2025-12-07 14:01:13] [ERROR] [app.services.file_search] Could not find JSON array in response
[2025-12-07 14:01:13] [ERROR] [app.services.file_search] Could not find JSON array in response
[2025-12-07 14:01:13] [WARNING] [app.services.file_search] No terms extracted, falling back to full contract search
[2025-12-07 14:01:13] [WARNING] [app.services.file_search] No terms extracted, falling back to full contract search
[2025-12-07 14:01:13] [INFO] [app.services.file_search] PHASE 1/2: General Search for all extracted clauses...
[2025-12-07 14:01:13] [INFO] [app.services.file_search] PHASE 1/2: General Search for all extracted clauses...
[2025-12-07 14:01:13] [INFO] [app.services.file_search] Using top_k=10 for comprehensive coverage
[2025-12-07 14:01:13] [INFO] [app.services.file_search] Using top_k=10 for comprehensive coverage
[2025-12-07 14:01:13] [INFO] [app.services.file_search] SEARCH: Querying Gemini File Search (Phase 1)...
[2025-12-07 14:01:13] [INFO] [app.services.file_search] SEARCH: Querying Gemini File Search (Phase 1)...
[2025-12-07 14:01:13] [INFO] [google_genai.models] AFC is enabled with max remote calls: 10.
[2025-12-07 14:01:25] [INFO] [app.services.file_search] Phase 1 retrieved 10 chunks
[2025-12-07 14:01:25] [INFO] [app.services.file_search] Phase 1 retrieved 10 chunks
[2025-12-07 14:01:25] [INFO] [app.services.file_search] MERGE: Combining general and sensitive chunks...
[2025-12-07 14:01:25] [INFO] [app.services.file_search] MERGE: Combining general and sensitive chunks...
[2025-12-07 14:01:25] [INFO] [app.services.file_search] Total 10 unique chunks 
[2025-12-07 14:01:25] [INFO] [app.services.file_search] Total 10 unique chunks 
[2025-12-07 14:01:25] [INFO] [app.services.file_search] ============================================================
[2025-12-07 14:01:25] [INFO] [app.services.file_search] ============================================================
[2025-12-07 14:01:25] [INFO] [app.routes.analysis_upload] Retrieved 10 AAOIFI chunks
[2025-12-07 14:01:25] [INFO] [app.routes.analysis_upload] AAOIFI context prepared: 12355 characters
[2025-12-07 14:01:25] [INFO] [app.routes.analysis_upload] Sending contract to LLM for analysis with AAOIFI context
[2025-12-07 14:01:25] [INFO] [app.services.ai_service] Sending text to LLM for session: 75afe9b1-6e2c-423f-bdc2-9733df8e68a6_analysis_final, payload length: 9459
[2025-12-07 14:01:25] [INFO] [app.services.ai_service] Creating new chat session for key: 75afe9b1-6e2c-423f-bdc2-9733df8e68a6_analysis_final
[2025-12-07 14:01:25] [INFO] [app.services.ai_service] Creating GenAI client with API Key: AIzaSyAK...5NAk
[2025-12-07 14:01:25] [WARNING] [google_genai._api_client] Both GOOGLE_API_KEY and GEMINI_API_KEY are set. Using GOOGLE_API_KEY.
[2025-12-07 14:01:26] [INFO] [app.services.ai_service] Sending request to AI API (attempt 1/3)
[2025-12-07 14:01:26] [INFO] [google_genai.models] AFC is enabled with max remote calls: 10.
[2025-12-07 14:02:14] [INFO] [app.services.ai_service] Received successful response for session 75afe9b1-6e2c-423f-bdc2-9733df8e68a6_analysis_final. Response text length: 15643
[2025-12-07 14:02:14] [INFO] [app.routes.analysis_upload] Parsing LLM analysis results
[2025-12-07 14:02:14] [INFO] [app.routes.analysis_upload] Analysis completed with 18 terms identified
[2025-12-07 14:02:14] [DEBUG] [app.utils.text_processing] Generated safe public_id: analysis_results_nmwdhj_qd_lmqwl_9891fb from base_name: nmwdhj_qd_lmqwl   
[2025-12-07 14:02:14] [DEBUG] [app.services.cloudinary_service] DEBUG: Attempting to upload to Cloudinary. File: C:\Users\Mostafa\AppData\Local\Temp\shariaa_analyzer_temp\processing_files\tmp9u33t017.json, Options: {'folder': 'shariaa_analyzer_uploads/75afe9b1-6e2c-423f-bdc2-9733df8e68a6/analysis_results_json', 'public_id': 'analysis_results_nmwdhj_qd_lmqwl_9891fb', 'resource_type': 'raw', 'overwrite': True}
[2025-12-07 14:02:14] [DEBUG] [app.services.cloudinary_service] DEBUG: Raw Cloudinary upload_result for C:\Users\Mostafa\AppData\Local\Temp\shariaa_analyzer_temp\processing_files\tmp9u33t017.json: {'asset_id': '0ca212a0e7d51f630a8208f920599236', 'public_id': 'shariaa_analyzer_uploads/75afe9b1-6e2c-423f-bdc2-9733df8e68a6/analysis_results_json/analysis_results_nmwdhj_qd_lmqwl_9891fb.json', 'version': 1765108935, 'version_id': '346ecb1c89206745d8ed7342085d40bf', 'signature': '497c6bd30913eb562260b613031e8c9657688460', 'resource_type': 'raw', 'created_at': '2025-12-07T12:02:15Z', 'tags': [], 'bytes': 24544, 'type': 'upload', 'etag': '206b11190b1c0d209c988da6d7542939', 'placeholder': False, 'url': 'http://res.cloudinary.com/dr6jicgld/raw/upload/v1765108935/shariaa_analyzer_uploads/75afe9b1-6e2c-423f-bdc2-9733df8e68a6/analysis_results_json/analysis_results_nmwdhj_qd_lmqwl_9891fb.json', 'secure_url': 'https://res.cloudinary.com/dr6jicgld/raw/upload/v1765108935/shariaa_analyzer_uploads/75afe9b1-6e2c-423f-bdc2-9733df8e68a6/analysis_results_json/analysis_results_nmwdhj_qd_lmqwl_9891fb.json', 'asset_folder': 'shariaa_analyzer_uploads/75afe9b1-6e2c-423f-bdc2-9733df8e68a6/analysis_results_json', 'display_name': 'analysis_results_nmwdhj_qd_lmqwl_9891fb.json', 'original_filename': 'tmp9u33t017', 'api_key': '961637465179968'}
[2025-12-07 14:02:14] [INFO] [app.services.cloudinary_service] Cloudinary upload successful. URL: https://res.cloudinary.com/dr6jicgld/raw/upload/v1765108935/shariaa_analyzer_uploads/75afe9b1-6e2c-423f-bdc2-9733df8e68a6/analysis_results_json/analysis_results_nmwdhj_qd_lmqwl_9891fb.json
[2025-12-07 14:02:14] [INFO] [app.routes.analysis_upload] Analysis results uploaded to Cloudinary
[2025-12-07 14:02:15] [INFO] [app.routes.analysis_upload] Contract document saved to database for session: 75afe9b1-6e2c-423f-bdc2-9733df8e68a6
[2025-12-07 14:02:15] [INFO] [app.routes.analysis_upload] Inserted 18 terms to database
[2025-12-07 14:02:15] [INFO] [app.routes.analysis_upload] Analysis completed successfully for session: 75afe9b1-6e2c-423f-bdc2-9733df8e68a6
[2025-12-07 14:02:15] [DEBUG] [app.routes.analysis_upload] Cleaned up temporary processing file
[2025-12-07 14:02:15] [DEBUG] [app.routes.analysis_upload] Cleaned up temporary analysis results file
[2025-12-07 14:02:15] [INFO] [app.routes.analysis_terms] Retrieving session details for ID: 75afe9b1-6e2c-423f-bdc2-9733df8e68a6
[2025-12-07 14:02:15] [INFO] [app.routes.analysis_terms] Retrieving terms for session: 75afe9b1-6e2c-423f-bdc2-9733df8e68a6